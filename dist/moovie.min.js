/*! moovie - v0.1.0 - 2016-07-17
* https://github.com/moovie/moovie#readme
* Copyright (c) 2016 ; Licensed MIT %> */
Element.implement({show:function(){return this.setStyle("display",""),this},hide:function(){return this.setStyle("display","none"),this}});var Moovie=function(a,b){b=b||{};var c=function(a,b){a.controls=!1;var c={debug:!1,autohideControls:!0,title:new URI(a.src).get("file"),playlist:[],captions:null,showCaptions:!0,captionLang:"en"};b=Object.merge(c,b),b.playlist.unshift({id:b.id,src:a.src,title:b.title});var d=a.getParent(),e=d.getParent();Element.NativeEvents.timeupdate||(Element.NativeEvents=Object.merge({abort:1,canplay:1,canplaythrough:1,durationchange:1,emptied:1,ended:1,loadeddata:1,loadedmetadata:1,loadstart:1,pause:1,play:1,playing:1,progress:2,ratechange:1,seeked:1,seeking:1,stalled:1,suspend:1,timeupdate:1,volumechange:1,waiting:1},Element.NativeEvents));var f=a.muted,g=function(a){var b=0,c=0,d=0,e=0,f="";return c=(a/3600).toInt(),b=a%3600,d=(b/60).toInt(),b%=60,e=b.toInt().toString(),1==e.length&&(e="0"+e),0!==c&&(f+=c+":"),f+d+":"+e},h=function(b){var c=o.progress.bar.getPosition().x,d=o.progress.bar.getSize().x,e=b-c,f=e/d*100,g=(a.duration||0)/100*f;return g},i=function(a){var b=o.volume.bar.getPosition().y,c=o.volume.bar.getSize().y,d=a-b,e=d/c*100,f=1-(.01*e).limit(0,1);return f};if(b.debug){var j=new Element("div",{class:"debug"});j.table=new Element("table"),j.table.body=new Element("tbody"),j.msg=new Element("p",{text:"Moovie instance ready."}),["autobuffer","autoplay","controls","loop","networkState","readyState","error","defaultPlaybackRate","playbackRate","duration","currentTime","startTime","seeking","paused","ended","volume","muted"].each(function(b){var c=new Element("tr"),d=new Element("td",{text:b});j[b]=new Element("td",{text:a[b]}),c.adopt(d,j[b]),j.table.body.grab(c)}),j.table.grab(j.table.body),j.adopt(j.table,j.msg),j.inject(e),a.addEvents({loadstart:function(b){j.networkState.set("text",a.networkState),j.networkState.getParent().highlight(),j.msg.set("html","Now looking for data..."),j.msg.highlight()},progress:function(b){j.networkState.set("text",a.networkState),j.networkState.getParent().highlight(),j.msg.set("html","Now fetching data..."),j.msg.highlight()},suspend:function(b){j.networkState.set("text",a.networkState),j.networkState.getParent().highlight(),j.msg.set("html","Data fetching <b>suspended</b>."),j.msg.highlight()},abort:function(b){j.networkState.set("text",a.networkState),j.networkState.getParent().highlight(),j.msg.set("html","Data fetching <b>aborted</b>."),j.msg.highlight()},error:function(b){j.networkState.set("text",a.networkState),j.networkState.getParent().highlight(),j.error.set("text",a.error.code),j.error.highlight(),j.msg.set("html","An error occurred while fetching data. See <b>error</b> attribute."),j.msg.highlight()},emptied:function(b){j.networkState.set("text",a.networkState),j.networkState.getParent().highlight(),j.msg.set("html","Media resource <b>emptied</b>. Possible error; see <b>error attribute."),j.msg.highlight()},stalled:function(b){j.networkState.set("text",a.networkState),j.networkState.getParent().highlight(),j.msg.set("html","Data throughput is <b>stalled</b>, possibly temporarily."),j.msg.highlight()},loadedmetadata:function(b){j.readyState.set("text",a.readyState),j.readyState.getParent().highlight(),j.msg.set("html","Duration and dimensions of media resource determined."),j.msg.highlight()},loadeddata:function(b){j.readyState.set("text",a.readyState),j.readyState.getParent().highlight(),j.msg.set("html","Some data available, but more is needed."),j.msg.highlight()},waiting:function(b){j.readyState.set("text",a.readyState),j.readyState.getParent().highlight(),j.msg.set("html","<b>Waiting</b> for more data..."),j.msg.highlight()},playing:function(b){j.readyState.set("text",a.readyState),j.readyState.getParent().highlight(),j.msg.set("html","Playback has started."),j.msg.highlight()},canplay:function(b){j.readyState.set("text",a.readyState),j.readyState.getParent().highlight(),j.msg.set("html","Playback possible, but will likely be interrupted for buffering before reaching the end."),j.msg.highlight()},canplaythrough:function(b){j.readyState.set("text",a.readyState),j.readyState.getParent().highlight(),j.msg.set("html","Most likely, uninterrupted playback all the way through to the end is now possible."),j.msg.highlight()},play:function(b){j.paused.set("text",a.paused),j.paused.getParent().highlight(),j.ended.set("text",a.ended)},pause:function(b){j.paused.set("text",a.paused),j.paused.getParent().highlight()},ended:function(b){j.ended.set("text",a.ended),j.ended.getParent().highlight()},timeupdate:function(b){j.currentTime.set("text",a.currentTime.round(3))},seeking:function(b){j.seeking.set("text",a.seeking),j.seeking.getParent().highlight()},seeked:function(b){j.seeking.set("text",a.seeking),j.seeking.getParent().highlight()},durationchange:function(b){j.duration.set("text",a.duration.round(3)),j.duration.getParent().highlight()},ratechange:function(b){j.playbackRate.set("text",a.playbackRate),j.playbackRate.getParent().highlight(),j.defaultPlaybackRate.set("text",a.defaultPlaybackRate),j.defaultPlaybackRate.getParent().highlight()},volumechange:function(b){j.muted.set("text",a.muted),j.muted.getParent().highlight(),j.volume.set("text",a.volume.round(3)),j.volume.getParent().highlight()}})}var k=new Element("div",{class:"captions"});k.caption=new Element("p"),k.grab(k.caption),k.hide();var l=new Element("div",{class:"overlay"});l.wrapper=new Element("div",{class:"wrapper"}),l.buffering=new Element("div",{class:"buffering",text:"Buffering..."}),l.play=new Element("div",{class:"play",text:"Play video"}),l.replay=new Element("div",{class:"replay",text:"Replay"}),l.paused=new Element("div",{class:"paused",text:"Paused"}),l.wrapper.adopt(l.buffering,l.play,l.replay,l.paused),l.grab(l.wrapper),l.set("tween",{duration:50}),l.fade("hide");var m=new Element("div",{class:"video-title",html:b.title});m.set("tween",{duration:2e3}),m.fade("hide");var n=new Element("div",{class:"panels"});n.info=new Element("div",{class:"info"}),n.settings=new Element("div",{class:"settings"}),n.about=new Element("div",{class:"about"}),n.playlist=new Element("div",{class:"playlist"}),n.adopt(n.info,n.settings,n.about,n.playlist),n.set("tween",{duration:250}),n.fade("hide"),n.info.set("html",'      <div class="heading">Video information</div>      <dl>        <dt class="title">Title</dt>        <dd>'+b.title+'</dd>                <dt class="url">URL</dt>        <dd>'+a.src+'</dd>                <dt class="size">Size</dt>        <dd></dd>      </dl>    '),n.settings.set("html",'      <div class="heading">Settings</div>            <div class="checkbox-widget" data-control="autohideControls" data-checked="'+b.autohideControls+'">        <div class="checkbox"></div>        <div class="label">Auto-hide controls</div>      </div>      <div class="checkbox-widget" data-control="loop" data-checked="'+(a.loop||!1)+'">        <div class="checkbox"></div>        <div class="label">Loop video</div>      </div>      <div class="checkbox-widget" data-control="showCaptions" data-checked="'+b.showCaptions+'">        <div class="checkbox"></div>        <div class="label">Show captions</div>      </div>    '),n.about.set("html",'      <div class="heading">About this player</div>      <p><b>Moovie</b> v1.0 <i>alpha</i></p>      <p>Copyright Â© 2010, Colin Aarts</p>      <p><a href="http://colinaarts.com/code/moovie/" rel="external">http://colinaarts.com/code/moovie/</a></p>    '),n.playlist.set("html",'    <div><div class="heading">Playlist</div></div>    <div><ol class="playlist"></ol></div>    '),b.playlist.each(function(a,b){var c=0===b?"active":"";n.playlist.getElement("ol.playlist").grab(new Element("li",{"data-index":b,class:c,html:'        <div class="checkbox-widget" data-checked="true">          <div class="checkbox"></div>          <div class="label">'+a.title+"</div>        </div>      "}))});var o=new Element("div",{class:"controls"});o.wrapper=new Element("div",{class:"wrapper"}),o.play=new Element("div",{class:"play"}),o.stop=new Element("div",{class:"stop"}),o.currentTime=new Element("div",{class:"current-time",text:"0.00"}),o.duration=new Element("div",{class:"duration",text:"0.00"}),o.settings=new Element("div",{class:"settings",title:"Settings"}),o.close=new Element("div",{class:"close",title:"Close panel"}),o.previous=b.playlist.length>1?new Element("div",{class:"previous",title:"Previous"}):null,o.next=b.playlist.length>1?new Element("div",{class:"next",title:"Next"}):null,o.progress=new Element("div",{class:"progress"}),o.progress.wrapper=new Element("div",{class:"wrapper"}),o.progress.bar=new Element("div",{class:"bar"}),o.progress.time=new Element("div",{class:"time"}).grab(new Element("div",{text:"0.00"})),o.progress.buffered=new Element("div",{class:"buffered"}),o.progress.played=new Element("div",{class:"played"}),o.progress.slider=new Element("div",{class:"slider"}),o.progress.wrapper.adopt(o.progress.bar,o.progress.buffered,o.progress.played,o.progress.slider,o.progress.time),o.progress.grab(o.progress.wrapper),o.progress.time.fade("hide"),o.volume=new Element("div",{class:"volume"}),o.volume.mute=new Element("div",{class:"mute"}),o.volume.wrapper=new Element("div",{class:"wrapper"}),o.volume.popup=new Element("div",{class:"popup"}),o.volume.bar=new Element("div",{class:"bar"}),o.volume.slider=new Element("div",{class:"slider"}),o.volume.popup.adopt(o.volume.bar,o.volume.slider),o.volume.wrapper.adopt(o.volume.mute,o.volume.popup),o.volume.grab(o.volume.wrapper),o.volume.popup.fade("hide"),o.volume.popup.set("tween",{duration:150}),o.more=new Element("div",{class:"more"}),o.more.wrapper=new Element("div",{class:"wrapper"}),o.more.popup=new Element("div",{class:"popup"}),o.more.about=new Element("div",{class:"about",title:"About"}),o.more.info=new Element("div",{class:"info",title:"Video info"}),o.more.playlist=new Element("div",{class:"playlist",title:"Playlist"}),o.more.popup.adopt(o.more.about,o.more.info,o.more.playlist),o.more.wrapper.grab(o.more.popup),o.more.grab(o.more.wrapper),o.more.popup.fade("hide"),o.more.popup.set("tween",{duration:150}),o.wrapper.adopt(o.play,o.stop,o.previous,o.next,o.currentTime,o.progress,o.duration,o.volume,o.settings,o.more,o.close),o.grab(o.wrapper),o.set("tween",{duration:150}),d.adopt(k,l,m,n,o),o.progress.slider.left=o.progress.slider.getStyle("left").toInt(),o.volume.slider.top=o.volume.slider.getStyle("top").toInt(),n.setStyle("height",n.getStyle("height").toInt()-o.getStyle("height").toInt()),function(){var a=n.playlist.getChildren("div:nth-child(2)")[0],b=0,c=a.getChildren().clone();a.empty(),b=a.getStyle("height"),a.adopt(c),a.getFirst().setStyle("height",b),$$(n.playlist,n.playlist.getChildren()).setStyle("display","block")}(),$$(o.progress.slider,o.volume.slider).each(function(b){var c=b.getParents(".progress").length?{y:!1}:{x:!1},d=b.getParents(".progress").length?function(a,b){var c=o.progress.bar.getPosition().x,d=o.progress.bar.getSize().x;b.page.x<c?a.setStyle("left",a.left):b.page.x>c+d&&a.setStyle("left",a.left+d),o.progress.time.update(!0,b.page.x)}:function(b,c){a.volume=i(c.page.y);var d=o.volume.bar.getPosition().y,e=o.volume.bar.getSize().y;c.page.y<d?b.setStyle("top",b.top):c.page.y>d+e&&b.setStyle("top",b.top+e)},e=b.getParents(".progress").length?function(b,c){b.beingDragged=!1,a.currentTime=h(c.page.x),a.paused&&a.play()}:function(a,b){a.beingDragged=!1};b.drag=new Drag(b,{modifiers:c,snap:0,onStart:function(){b.beingDragged=!0},onDrag:d,onComplete:e,onCancel:function(){b.beingDragged=!0}})}),l.update=function(a){"none"==a?this.fade("out"):(this.wrapper.getChildren().hide(),this[a].show(),this.fade("in"))},m.show=function(){var a=n.playlist.getActive().index,c=b.playlist[a].title;m.set("html",(a+1).toString()+". "+c),m.fade("in");var d=setTimeout(function(){m.fade("out"),d=null},6e3)},n.update=function(a){"none"==a||this[a].hasClass("active")?(this.getChildren(".active").removeClass("active"),this.fade("out")):(this.getChildren().hide().removeClass("active"),this[a].show().addClass("active"),this.fade("in"))},n.playlist.play=function(c){var d=n.playlist.getActive(),e=(d.element,d.index),f=b.playlist.length,g=0;"previous"==c?(g=e-1,g<0&&(g=f-1)):"next"==c?(g=e+1,g>f-1&&(g=0)):"number"==$type(c)&&(g=c),n.playlist.setActive(g),a.src=b.playlist[g].src,a.load(),a.play(),b.captions=Moovie.captions[b.playlist[g].id],m.show(),n.info.getElement("dt.title + dd").set("html",b.playlist[g].title||new URI(b.playlist[g].src).get("file")),n.info.getElement("dt.url + dd").set("html",b.playlist[g].src)},n.playlist.getActive=function(){var a=n.playlist.getElement("ol.playlist li.active"),b=+a.get("data-index");return{element:a,index:b}},n.playlist.setActive=function(a){var b=n.playlist.getActive().element;b.removeClass("active"),n.playlist.getElement('ol.playlist li[data-index="'+a+'"]').addClass("active")},o.play.update=function(b){a.paused||a.ended?this.removeClass("paused"):this.addClass("paused")},o.progress.update=function(b){if(!o.progress.slider.beingDragged){var c=o.progress.slider,d=a.currentTime/a.duration*100,e=o.progress.bar.getSize().x,f=e/100*d;c.setStyle("left",f+c.left+"px")}},o.progress.time.update=function(a,b){o.progress.time.fade("show");var c=o.progress.bar.getPosition().x;if(b){var d=o.progress.slider.getPosition().x;o.progress.time.setStyle("left",d-c-o.progress.slider.left+"px"),a=d-o.progress.slider.left}else o.progress.time.setStyle("left",a-c+"px");this.getFirst().set("text",g(h(a)))},o.volume.update=function(b){var c=!(f==a.muted);if(f=a.muted,c&&!a.muted&&0===a.volume?a.volume=.5:a.muted&&0!==a.volume&&!c?a.muted=!1:c||a.muted||0!==a.volume||(a.muted=!0),a.muted?o.volume.mute.addClass("muted"):o.volume.mute.removeClass("muted"),!o.volume.slider.beingDragged){var d=o.volume.slider,e=a.muted&&c?0:a.volume,g=o.volume.bar.getSize().y,h=g-e*g;d.setStyle("top",h+d.top)}},o.currentTime.update=o.duration.update=function(a){this.set("text",g(a))},d.addEvent("mouseenter",function(a){o.fade("in")}),d.addEvent("mouseleave",function(a){b.autohideControls&&o.fade("out")}),$$(l.play,l.replay).addEvent("click",function(b){a.play(),m.show()}),$$(l.paused).addEvent("click",function(b){a.play()}),n.addEvent("click:relay(.checkbox-widget)",function(c){"false"==this.get("data-checked")?this.set("data-checked","true"):this.set("data-checked","false");var d=this.get("data-control"),e=this.get("data-checked");switch(d){case"autohideControls":b.autohideControls="true"==e;break;case"loop":a.loop="true"==e;break;case"showCaptions":b.showCaptions="true"==e}}),n.playlist.addEvent("click:relay(.label)",function(a){a.stop();var b=this.getParents("li")[0],c=+b.get("data-index");n.playlist.play(c)}),o.play.addEvent("click",function(b){a.paused&&a.readyState>=3?a.play():!a.paused&&a.ended?a.currentTime=0:a.paused||a.pause()}),o.stop.addEvent("click",function(b){a.currentTime=0,a.pause()}),b.playlist.length>1&&(o.previous.addEvent("click",function(a){n.playlist.play("previous")}),o.next.addEvent("click",function(a){n.playlist.play("next")})),o.progress.bar.addEvent("click",function(b){a.currentTime=h(b.page.x),a.paused&&a.play()}),o.progress.bar.addEvent("mousemove",function(a){o.progress.time.update(a.page.x,!1)}),o.progress.slider.addEvent("mouseenter",function(a){o.progress.time.update(a.page.x,!0)}),o.progress.bar.addEvent("mouseleave",function(a){o.progress.time.fade("hide")}),o.progress.slider.addEvent("mouseleave",function(a){o.progress.time.fade("hide")}),o.volume.mute.addEvent("click",function(b){a.muted?a.muted=!1:a.muted=!0}),o.volume.addEvent("mouseenter",function(a){o.volume.popup.fade("in")}),o.volume.addEvent("mouseleave",function(a){o.volume.popup.fade("out")}),o.volume.bar.addEvent("click",function(b){a.volume=i(b.page.y)}),o.more.addEvent("mouseenter",function(a){o.more.popup.fade("in")}),o.more.addEvent("mouseleave",function(a){o.more.popup.fade("out")}),o.more.about.addEvent("click",function(a){n.update("about")}),o.more.info.addEvent("click",function(a){n.update("info")}),o.more.playlist.addEvent("click",function(a){n.update("playlist")}),o.settings.addEvent("click",function(a){n.update("settings")}),o.close.addEvent("click",function(a){n.update("none")}),a.addEvents({click:function(b){a.pause(),l.update("paused")},play:function(a){o.play.update(),l.update("none")},pause:function(a){o.play.update()},ended:function(a){b.playlist.length>1?n.playlist.play("next"):(o.play.update(),l.update("replay"))},progress:function(a){if(a.event.lengthComputable){var b=a.event.loaded/a.event.total*100;o.progress.buffered.setStyle("width",b+"%");var c=(a.event.total/1024/1024).round(2);n.info.getElement("dt.size + dd").set("html",c+" MB")}},seeking:function(a){l.update("buffering")},seeked:function(b){l.update("none"),a.paused||o.play.update()},timeupdate:function(c){o.currentTime.update(a.currentTime),o.progress.update();var d=!1;b.captions&&b.showCaptions&&b.captions[b.captionLang].each(function(b){a.currentTime>=b.start/1e3&&a.currentTime<=b.end/1e3&&(k.caption.set("html",b.text),k.show(),d=!0)}),d||(k.caption.set("html",""),k.hide())},durationchange:function(b){o.duration.update(a.duration)},volumechange:function(a){o.volume.update()},abort:function(a){},emptied:function(a){}}),a.autoplay||l.update("play");new Tips(d.getElements("[title]"),{className:"video-tip",title:"",text:function(a){return a.get("title")}})};a.each(function(a){"element"==typeOf(a)?a.Moovie=new c(a,b):"object"==typeOf(a)&&(a.options=a.options||{},a.options.id=a.id||null,a.options.captions=Moovie.captions[a.id]||null,a.video.Moovie=new c(a.video,Object.merge(b,a.options)))})};Moovie.captions={},Moovie.languages={en:"English"},Moovie.registerCaptions=function(a,b){this.captions[a]=b};