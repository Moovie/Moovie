/*!
* Moovie: an advanced HTML5 video player for MooTools.
*
* @see http://colinaarts.com/code/moovie
* @version 0.2.0
* @author Colin Aarts <colin@colinaarts.com> (http://colinaarts.com)
* @author Nathan Bishop <nbish11@hotmail.com>
* @copyright 2010 Colin Aarts
* @license MIT
*/
Element.implement({show:function(){"use strict";return this.setStyle("display",""),this},hide:function(){"use strict";return this.setStyle("display","none"),this}});var Moovie=function(a,b){"use strict";b=b||{},a.each(function(a){"element"==typeOf(a)?a.Moovie=new Moovie.Doit(a,b):"object"==typeOf(a)&&(a.options=a.options||{},a.options.id=a.id||null,a.options.captions=Moovie.captions[a.id]||null,a.video.Moovie=new Moovie.Doit(a.video,Object.merge(b,a.options)))})};Moovie.Doit=function(a,b){a.controls=!1;var c={debug:!1,autohideControls:!0,title:new URI(a.src).get("file"),playlist:[],captions:null,showCaptions:!0,captionLang:"en"};b=Object.merge(c,b),b.playlist.unshift({id:b.id,src:a.src,title:b.title});var d=new Element("div.moovie"),e=new Element("div.wrapper");d.replaces(a);var f=a.clone(!0,!0);a.destroy(),a=f,e.grab(a),d.grab(e),Element.NativeEvents.timeupdate||(Element.NativeEvents=Object.merge({abort:1,canplay:1,canplaythrough:1,durationchange:1,emptied:1,ended:1,loadeddata:1,loadedmetadata:1,loadstart:1,pause:1,play:1,playing:1,progress:2,ratechange:1,seeked:1,seeking:1,stalled:1,suspend:1,timeupdate:1,volumechange:1,waiting:1},Element.NativeEvents));var g=a.muted,h=!1,i=function(a){var b=0,c=0,d=0,e=0,f="";return c=(a/3600).toInt(),b=a%3600,d=(b/60).toInt(),b%=60,e=b.toInt().toString(),1==e.length&&(e="0"+e),0!==c&&(f+=c+":"),f+d+":"+e},j=function(b){var c=q.progress.bar.getPosition().x,d=q.progress.bar.getSize().x,e=b-c,f=e/d*100,g=(a.duration||0)/100*f;return g},k=function(a){var b=q.volume.bar.getPosition().y,c=q.volume.bar.getSize().y,d=a-b,e=d/c*100,f=1-(.01*e).limit(0,1);return f};if(b.debug){var l=new Element("div",{class:"debug"});l.table=new Element("table"),l.table.body=new Element("tbody"),l.msg=new Element("p",{text:"Moovie instance ready."}),["autobuffer","autoplay","controls","loop","networkState","readyState","error","defaultPlaybackRate","playbackRate","duration","currentTime","startTime","seeking","paused","ended","volume","muted"].each(function(b){var c=new Element("tr"),d=new Element("td",{text:b});l[b]=new Element("td",{text:a[b]}),c.adopt(d,l[b]),l.table.body.grab(c)}),l.table.grab(l.table.body),l.adopt(l.table,l.msg),l.inject(d),a.addEvents({loadstart:function(b){l.networkState.set("text",a.networkState),l.networkState.getParent().highlight(),l.msg.set("html","Now looking for data..."),l.msg.highlight()},progress:function(b){l.networkState.set("text",a.networkState),l.networkState.getParent().highlight(),l.msg.set("html","Now fetching data..."),l.msg.highlight()},suspend:function(b){l.networkState.set("text",a.networkState),l.networkState.getParent().highlight(),l.msg.set("html","Data fetching <b>suspended</b>."),l.msg.highlight()},abort:function(b){l.networkState.set("text",a.networkState),l.networkState.getParent().highlight(),l.msg.set("html","Data fetching <b>aborted</b>."),l.msg.highlight()},error:function(b){l.networkState.set("text",a.networkState),l.networkState.getParent().highlight(),l.error.set("text",a.error.code),l.error.highlight(),l.msg.set("html","An error occurred while fetching data. See <b>error</b> attribute."),l.msg.highlight()},emptied:function(b){l.networkState.set("text",a.networkState),l.networkState.getParent().highlight(),l.msg.set("html","Media resource <b>emptied</b>. Possible error; see <b>error attribute."),l.msg.highlight()},stalled:function(b){l.networkState.set("text",a.networkState),l.networkState.getParent().highlight(),l.msg.set("html","Data throughput is <b>stalled</b>, possibly temporarily."),l.msg.highlight()},loadedmetadata:function(b){l.readyState.set("text",a.readyState),l.readyState.getParent().highlight(),l.msg.set("html","Duration and dimensions of media resource determined."),l.msg.highlight()},loadeddata:function(b){l.readyState.set("text",a.readyState),l.readyState.getParent().highlight(),l.msg.set("html","Some data available, but more is needed."),l.msg.highlight()},waiting:function(b){l.readyState.set("text",a.readyState),l.readyState.getParent().highlight(),l.msg.set("html","<b>Waiting</b> for more data..."),l.msg.highlight()},playing:function(b){l.readyState.set("text",a.readyState),l.readyState.getParent().highlight(),l.msg.set("html","Playback has started."),l.msg.highlight()},canplay:function(b){l.readyState.set("text",a.readyState),l.readyState.getParent().highlight(),l.msg.set("html","Playback possible, but will likely be interrupted for buffering before reaching the end."),l.msg.highlight()},canplaythrough:function(b){l.readyState.set("text",a.readyState),l.readyState.getParent().highlight(),l.msg.set("html","Most likely, uninterrupted playback all the way through to the end is now possible."),l.msg.highlight()},play:function(b){l.paused.set("text",a.paused),l.paused.getParent().highlight(),l.ended.set("text",a.ended)},pause:function(b){l.paused.set("text",a.paused),l.paused.getParent().highlight()},ended:function(b){l.ended.set("text",a.ended),l.ended.getParent().highlight()},timeupdate:function(b){l.currentTime.set("text",a.currentTime.round(3))},seeking:function(b){l.seeking.set("text",a.seeking),l.seeking.getParent().highlight()},seeked:function(b){l.seeking.set("text",a.seeking),l.seeking.getParent().highlight()},durationchange:function(b){l.duration.set("text",a.duration.round(3)),l.duration.getParent().highlight()},ratechange:function(b){l.playbackRate.set("text",a.playbackRate),l.playbackRate.getParent().highlight(),l.defaultPlaybackRate.set("text",a.defaultPlaybackRate),l.defaultPlaybackRate.getParent().highlight()},volumechange:function(b){l.muted.set("text",a.muted),l.muted.getParent().highlight(),l.volume.set("text",a.volume.round(3)),l.volume.getParent().highlight()}})}var m=new Element("div",{class:"captions"});m.caption=new Element("p"),m.grab(m.caption),m.hide();var n=new Element("div",{class:"overlay"});n.wrapper=new Element("div",{class:"wrapper"}),n.buffering=new Element("div",{class:"buffering",text:"Buffering..."}),n.play=new Element("div",{class:"play",text:"Play video"}),n.replay=new Element("div",{class:"replay",text:"Replay"}),n.paused=new Element("div",{class:"paused",text:"Paused"}),n.wrapper.adopt(n.buffering,n.play,n.replay,n.paused),n.grab(n.wrapper),n.set("tween",{duration:50}),n.fade("hide");var o=new Element("div",{class:"video-title",html:b.title});o.set("tween",{duration:2e3}),o.fade("hide");var p=new Element("div",{class:"panels"});p.info=new Element("div",{class:"info"}),p.settings=new Element("div",{class:"settings"}),p.about=new Element("div",{class:"about"}),p.playlist=new Element("div",{class:"playlist"}),p.adopt(p.info,p.settings,p.about,p.playlist),p.set("tween",{duration:250}),p.fade("hide"),p.info.set("html",'    <div class="heading">Video information</div>    <dl>      <dt class="title">Title</dt>      <dd>'+b.title+'</dd>            <dt class="url">URL</dt>      <dd>'+a.src+'</dd>            <dt class="size">Size</dt>      <dd></dd>    </dl>  '),p.settings.set("html",'    <div class="heading">Settings</div>        <div class="checkbox-widget" data-control="autohideControls" data-checked="'+b.autohideControls+'">      <div class="checkbox"></div>      <div class="label">Auto-hide controls</div>    </div>    <div class="checkbox-widget" data-control="loop" data-checked="'+(a.loop||!1)+'">      <div class="checkbox"></div>      <div class="label">Loop video</div>    </div>    <div class="checkbox-widget" data-control="showCaptions" data-checked="'+b.showCaptions+'">      <div class="checkbox"></div>      <div class="label">Show captions</div>    </div>  '),p.about.set("html",'    <div class="heading">About this player</div>    <p><b>Moovie</b> v1.0 <i>alpha</i></p>    <p>Copyright Â© 2010, Colin Aarts</p>    <p><a href="http://colinaarts.com/code/moovie/" rel="external">http://colinaarts.com/code/moovie/</a></p>  '),p.playlist.set("html",'      <div><div class="heading">Playlist</div></div>      <div><ol class="playlist"></ol></div>  '),b.playlist.each(function(a,b){var c=0===b?"active":"";p.playlist.getElement("ol.playlist").grab(new Element("li",{"data-index":b,class:c,html:'      <div class="checkbox-widget" data-checked="true">        <div class="checkbox"></div>        <div class="label">'+a.title+"</div>      </div>    "}))});var q=new Element("div",{class:"controls"});q.wrapper=new Element("div",{class:"wrapper"}),q.play=new Element("div",{class:"play"}),q.stop=new Element("div",{class:"stop"}),q.currentTime=new Element("div",{class:"current-time",text:"0.00"}),q.duration=new Element("div",{class:"duration",text:"0.00"}),q.settings=new Element("div",{class:"settings",title:"Settings"}),q.close=new Element("div",{class:"close",title:"Close panel"}),q.previous=b.playlist.length>1?new Element("div",{class:"previous",title:"Previous"}):null,q.next=b.playlist.length>1?new Element("div",{class:"next",title:"Next"}):null,q.progress=new Element("div",{class:"progress"}),q.progress.wrapper=new Element("div",{class:"wrapper"}),q.progress.bar=new Element("div",{class:"bar"}),q.progress.time=new Element("div",{class:"time"}).grab(new Element("div",{text:"0.00"})),q.progress.buffered=new Element("div",{class:"buffered"}),q.progress.played=new Element("div",{class:"played"}),q.progress.slider=new Element("div",{class:"slider"}),q.progress.wrapper.adopt(q.progress.bar,q.progress.buffered,q.progress.played,q.progress.slider,q.progress.time),q.progress.grab(q.progress.wrapper),q.progress.time.fade("hide"),q.volume=new Element("div",{class:"volume"}),q.volume.mute=new Element("div",{class:"mute"}),q.volume.wrapper=new Element("div",{class:"wrapper"}),q.volume.popup=new Element("div",{class:"popup"}),q.volume.bar=new Element("div",{class:"bar"}),q.volume.slider=new Element("div",{class:"slider"}),q.volume.popup.adopt(q.volume.bar,q.volume.slider),q.volume.wrapper.adopt(q.volume.mute,q.volume.popup),q.volume.grab(q.volume.wrapper),q.volume.popup.fade("hide"),q.volume.popup.set("tween",{duration:150}),q.more=new Element("div",{class:"more"}),q.more.wrapper=new Element("div",{class:"wrapper"}),q.more.popup=new Element("div",{class:"popup"}),q.more.about=new Element("div",{class:"about",title:"About"}),q.more.info=new Element("div",{class:"info",title:"Video info"}),q.more.playlist=new Element("div",{class:"playlist",title:"Playlist"}),q.more.popup.adopt(q.more.about,q.more.info,q.more.playlist),q.more.wrapper.grab(q.more.popup),q.more.grab(q.more.wrapper),q.more.popup.fade("hide"),q.more.popup.set("tween",{duration:150}),q.wrapper.adopt(q.play,q.stop,q.previous,q.next,q.currentTime,q.progress,q.duration,q.volume,q.settings,q.more,q.close),q.grab(q.wrapper),q.set("tween",{duration:150}),e.adopt(m,n,o,p,q),q.progress.slider.left=q.progress.slider.getStyle("left").toInt(),q.volume.slider.top=q.volume.slider.getStyle("top").toInt(),$$(q.progress.slider,q.volume.slider).each(function(b){var c=b.getParents(".progress").length?{y:!1}:{x:!1},d=b.getParents(".progress").length?function(a,b){var c=q.progress.bar.getPosition().x,d=q.progress.bar.getSize().x;b.page.x<c?a.setStyle("left",a.left):b.page.x>c+d&&a.setStyle("left",a.left+d),q.progress.time.update(!0,b.page.x)}:function(b,c){a.volume=k(c.page.y);var d=q.volume.bar.getPosition().y,e=q.volume.bar.getSize().y;c.page.y<d?b.setStyle("top",b.top):c.page.y>d+e&&b.setStyle("top",b.top+e)},e=b.getParents(".progress").length?function(b,c){b.beingDragged=!1,a.currentTime=j(c.page.x),a.paused&&a.play()}:function(a,b){a.beingDragged=!1};b.drag=new Drag(b,{modifiers:c,snap:0,onStart:function(){b.beingDragged=!0},onDrag:d,onComplete:e,onCancel:function(){b.beingDragged=!0}})}),n.update=function(a){"none"==a?this.fade("out"):(this.wrapper.getChildren().hide(),this[a].show(),this.fade("in"))},o.show=function(){var a=p.playlist.getActive().index,c=b.playlist[a].title;o.set("html",(a+1).toString()+". "+c),o.fade("in");var d=setTimeout(function(){o.fade("out"),d=null},6e3)},p.update=function(a){h===!1&&(h=!0,p.setStyle("height",p.getStyle("height").toInt()-q.getStyle("height").toInt())),"none"==a||this[a].hasClass("active")?(this.getChildren(".active").removeClass("active"),this.fade("out")):(this.getChildren().hide().removeClass("active"),this[a].show().addClass("active"),this.fade("in"))},p.playlist.play=function(c){var d=p.playlist.getActive(),e=(d.element,d.index),f=b.playlist.length,g=0;"previous"==c?(g=e-1,g<0&&(g=f-1)):"next"==c?(g=e+1,g>f-1&&(g=0)):"number"==typeOf(c)&&(g=c),p.playlist.setActive(g),a.src=b.playlist[g].src,a.load(),a.play(),b.captions=Moovie.captions[b.playlist[g].id],o.show(),p.info.getElement("dt.title + dd").set("html",b.playlist[g].title||new URI(b.playlist[g].src).get("file")),p.info.getElement("dt.url + dd").set("html",b.playlist[g].src)},p.playlist.getActive=function(){var a=p.playlist.getElement("ol.playlist li.active"),b=+a.get("data-index");return{element:a,index:b}},p.playlist.setActive=function(a){var b=p.playlist.getActive().element;b.removeClass("active"),p.playlist.getElement('ol.playlist li[data-index="'+a+'"]').addClass("active")},q.play.update=function(b){a.paused||a.ended?this.removeClass("paused"):this.addClass("paused")},q.progress.update=function(b){if(!q.progress.slider.beingDragged){var c=q.progress.slider,d=a.currentTime/a.duration*100,e=q.progress.bar.getSize().x,f=e/100*d;c.setStyle("left",f+c.left+"px")}},q.progress.time.update=function(a,b){q.progress.time.fade("show");var c=q.progress.bar.getPosition().x;if(b){var d=q.progress.slider.getPosition().x;q.progress.time.setStyle("left",d-c-q.progress.slider.left+"px"),a=d-q.progress.slider.left}else q.progress.time.setStyle("left",a-c+"px");this.getFirst().set("text",i(j(a)))},q.volume.update=function(b){var c=g!=a.muted;if(g=a.muted,c&&!a.muted&&0===a.volume?a.volume=.5:a.muted&&0!==a.volume&&!c?a.muted=!1:c||a.muted||0!==a.volume||(a.muted=!0),a.muted?q.volume.mute.addClass("muted"):q.volume.mute.removeClass("muted"),!q.volume.slider.beingDragged){var d=q.volume.slider,e=a.muted&&c?0:a.volume,f=q.volume.bar.getSize().y,h=f-e*f;d.setStyle("top",h+d.top)}},q.currentTime.update=q.duration.update=function(a){this.set("text",i(a))},e.addEvent("mouseenter",function(a){q.fade("in")}),e.addEvent("mouseleave",function(a){b.autohideControls&&q.fade("out")}),$$(n.play,n.replay).addEvent("click",function(b){a.play(),o.show()}),$$(n.paused).addEvent("click",function(b){a.play()}),p.settings.addEvent("click:relay(.checkbox-widget)",function(c){"false"==this.get("data-checked")?this.set("data-checked","true"):this.set("data-checked","false");var d=this.get("data-control"),e=this.get("data-checked");switch(d){case"autohideControls":b.autohideControls="true"==e;break;case"loop":a.loop="true"==e;break;case"showCaptions":b.showCaptions="true"==e}p.update("none")}),p.playlist.addEvent("click:relay(.label)",function(a){a.stop();var b=this.getParents("li")[0],c=b.get("data-index").toInt();p.playlist.play(c),p.update("none")}),q.play.addEvent("click",function(b){a.paused&&a.readyState>=3?a.play():!a.paused&&a.ended?a.currentTime=0:a.paused||a.pause()}),q.stop.addEvent("click",function(b){a.currentTime=0,a.pause()}),b.playlist.length>1&&(q.previous.addEvent("click",function(a){p.playlist.play("previous")}),q.next.addEvent("click",function(a){p.playlist.play("next")})),q.progress.bar.addEvent("click",function(b){a.currentTime=j(b.page.x),a.paused&&a.play()}),q.progress.bar.addEvent("mousemove",function(a){q.progress.time.update(a.page.x,!1)}),q.progress.slider.addEvent("mouseenter",function(a){q.progress.time.update(a.page.x,!0)}),q.progress.bar.addEvent("mouseleave",function(a){q.progress.time.fade("hide")}),q.progress.slider.addEvent("mouseleave",function(a){q.progress.time.fade("hide")}),q.volume.mute.addEvent("click",function(b){a.muted?a.muted=!1:a.muted=!0}),q.volume.addEvent("mouseenter",function(a){q.volume.popup.fade("in")}),q.volume.addEvent("mouseleave",function(a){q.volume.popup.fade("out")}),q.volume.bar.addEvent("click",function(b){a.volume=k(b.page.y)}),q.more.addEvent("mouseenter",function(a){q.more.popup.fade("in")}),q.more.addEvent("mouseleave",function(a){q.more.popup.fade("out")}),q.more.about.addEvent("click",function(a){p.update("about")}),q.more.info.addEvent("click",function(a){p.update("info")}),q.more.playlist.addEvent("click",function(a){p.update("playlist")}),q.settings.addEvent("click",function(a){p.update("settings")}),q.close.addEvent("click",function(a){p.update("none")}),a.addEvents({click:function(b){a.pause(),n.update("paused")},play:function(a){q.play.update(),n.update("none"),q.show()},pause:function(a){q.play.update()},ended:function(a){b.playlist.length>1?p.playlist.play("next"):(q.play.update(),n.update("replay"))},progress:function(a){if(a.event.lengthComputable){var b=a.event.loaded/a.event.total*100;q.progress.buffered.setStyle("width",b+"%");var c=(a.event.total/1024/1024).round(2);p.info.getElement("dt.size + dd").set("html",c+" MB")}},seeking:function(a){n.update("buffering")},seeked:function(b){n.update("none"),a.paused||q.play.update()},timeupdate:function(c){q.currentTime.update(a.currentTime),q.progress.update();var d=!1;b.captions&&b.showCaptions&&b.captions[b.captionLang].each(function(b){a.currentTime>=b.start/1e3&&a.currentTime<=b.end/1e3&&(m.caption.set("html",b.text),m.show(),d=!0)}),d||(m.caption.set("html",""),m.hide())},durationchange:function(b){q.duration.update(a.duration)},volumechange:function(a){q.volume.update()},abort:function(a){},emptied:function(a){}}),a.autoplay||(n.update("play"),q.hide());new Tips(e.getElements("[title]"),{className:"video-tip",title:"",text:function(a){return a.get("title")}})},Moovie.captions={},Moovie.languages={en:"English"},Moovie.registerCaptions=function(a,b){this.captions[a]=b};
